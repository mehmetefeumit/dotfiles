#!/usr/bin/env bash
#
# migrate-config - Simple tool to migrate a config to dotfiles
#
# Usage: migrate-config <config-name>
# Example: migrate-config nvim
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Configuration
DOTFILES="${DOTFILES:-$HOME/dotfiles}"
CONFIG_SOURCE="$HOME/.config"

# Print functions
error() {
  echo -e "${RED}✗${NC} $*" >&2
  exit 1
}
success() { echo -e "${GREEN}✓${NC} $*"; }
warning() { echo -e "${YELLOW}⚠${NC} $*"; }

# Check arguments
[ $# -eq 0 ] && error "Usage: migrate-config <config-name>"

CONFIG_NAME="$1"
SOURCE_PATH="$CONFIG_SOURCE/$CONFIG_NAME"
DEST_PATH="$DOTFILES/.config/$CONFIG_NAME"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Migrating: $CONFIG_NAME"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# ============================================
# STEP 1: PRE-REQUISITE CHECKS
# ============================================

echo "→ Running pre-requisite checks..."

# Check if source exists
[ ! -e "$SOURCE_PATH" ] && error "$CONFIG_NAME doesn't exist in ~/.config/"

# Check if already a symlink to dotfiles
if [ -L "$SOURCE_PATH" ]; then
  target=$(readlink "$SOURCE_PATH")
  if [[ "$target" == *"dotfiles"* ]]; then
    error "$CONFIG_NAME is already migrated"
  else
    error "$CONFIG_NAME is a symlink to: $target (not to dotfiles)"
  fi
fi

# Check if dotfiles directory exists
if [ ! -d "$DOTFILES" ]; then
  error "Dotfiles directory doesn't exist: $DOTFILES"
fi

# Check if destination already exists
if [ -e "$DEST_PATH" ]; then
  error "Destination already exists: $DEST_PATH"
fi

# Check write permissions
[ ! -w "$CONFIG_SOURCE" ] && error "No write permission to ~/.config/"
[ ! -w "$DOTFILES" ] && error "No write permission to $DOTFILES"

success "All checks passed"

# Show what will happen
echo ""
echo "Source:      $SOURCE_PATH"
echo "Destination: $DEST_PATH"
echo "Size:        $(du -sh "$SOURCE_PATH" 2>/dev/null | cut -f1)"
echo ""

# Confirm
read -rp "Proceed? [y/N] " response
[[ ! "$response" =~ ^[Yy]$ ]] && {
  echo "Cancelled."
  exit 0
}

# ============================================
# STEP 2: MOVE AND SYMLINK
# ============================================

echo ""
echo "→ Moving to dotfiles..."

# Ensure destination parent directory exists
mkdir -p "$DOTFILES/.config"

# Move the config
if ! mv "$SOURCE_PATH" "$DEST_PATH"; then
  error "Failed to move $CONFIG_NAME"
fi

success "Moved to $DEST_PATH"

echo "→ Creating symlink..."

# Create symlink
if ! ln -s "$DEST_PATH" "$SOURCE_PATH"; then
  error "Failed to create symlink. Restoring original..."
  mv "$DEST_PATH" "$SOURCE_PATH"
  exit 1
fi

success "Created symlink: $SOURCE_PATH -> $DEST_PATH"

# Verify symlink works
if [ ! -e "$SOURCE_PATH" ]; then
  error "Symlink verification failed. Restoring original..."
  rm -f "$SOURCE_PATH"
  mv "$DEST_PATH" "$SOURCE_PATH"
  exit 1
fi

success "Symlink verified"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
success "Migration complete!"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Don't forget to commit to git:"
echo "  cd $DOTFILES"
echo "  git add .config/$CONFIG_NAME"
echo "  git commit -m 'Add $CONFIG_NAME config'"
